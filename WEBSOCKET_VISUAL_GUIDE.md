# 🎨 WebSocket - Визуальный гайд

Простое объяснение как работает WebSocket в CyberHub.

---

## 🔌 Как это работает?

```
┌─────────────────────────────────────────────────────────┐
│                     ПОЛЬЗОВАТЕЛЬ                        │
│  Открывает сайт в браузере или .exe приложении          │
└─────────────────┬───────────────────────────────────────┘
                  │
                  │ 1. Подключается WebSocket
                  ▼
┌─────────────────────────────────────────────────────────┐
│                  FRONTEND (React)                        │
│  • WebSocketContext автоматически подключается           │
│  • Отправляет userId при авторизации                     │
│  • Слушает события: cases:updated, balance:updated       │
│  • Показывает индикатор подключения (Wi-Fi иконка)       │
└─────────────────┬───────────────────────────────────────┘
                  │
                  │ WebSocket соединение
                  │ ws://91.107.120.48:3000
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                  BACKEND (Node.js)                       │
│  • Socket.IO принимает подключение                       │
│  • Создает комнату для пользователя: user:${userId}      │
│  • Отправляет события при изменениях                     │
└─────────────────────────────────────────────────────────┘
```

---

## 📦 Сценарий 1: Админ добавляет кейс

```
АДМИН
  │
  │ 1. Открывает админку
  │ 2. Нажимает "Добавить кейс"
  │ 3. Заполняет форму
  │ 4. Нажимает "Создать"
  │
  ▼
BACKEND
  │
  │ 5. POST /api/admin/cases
  │ 6. Сохраняет кейс в базу данных
  │ 7. io.emit('cases:updated')  ← Отправляет событие
  │
  ▼
FRONTEND (все пользователи)
  │
  │ 8. Получает событие 'cases:updated'
  │ 9. setCasesRefreshKey(prev => prev + 1)
  │ 10. CasesPage автоматически обновляется
  │ 11. Пользователи видят новый кейс БЕЗ перезагрузки!
  │
  ✅ ГОТОВО!
```

**Результат:** Новый кейс появляется у всех пользователей мгновенно!

---

## 💰 Сценарий 2: Пользователь открывает кейс

```
ПОЛЬЗОВАТЕЛЬ
  │
  │ 1. Нажимает "Открыть кейс"
  │
  ▼
FRONTEND
  │
  │ 2. POST /api/cases/open
  │
  ▼
BACKEND
  │
  │ 3. Проверяет баланс
  │ 4. Списывает деньги
  │ 5. Выбирает случайный предмет
  │ 6. Добавляет в инвентарь
  │ 7. io.to(`user:${userId}`).emit('balance:updated:${userId}')
  │ 8. io.to(`user:${userId}`).emit('inventory:updated:${userId}')
  │
  ▼
FRONTEND (только этот пользователь)
  │
  │ 9. Получает 'balance:updated'
  │ 10. refreshProfile() - обновляет баланс
  │ 11. TopBar показывает новый баланс
  │ 12. Получает 'inventory:updated'
  │ 13. Инвентарь обновляется
  │
  ✅ ГОТОВО!
```

**Результат:** Баланс и инвентарь обновляются автоматически!

---

## 💵 Сценарий 3: Пользователь пополняет баланс

```
ПОЛЬЗОВАТЕЛЬ
  │
  │ 1. Нажимает "Пополнить"
  │ 2. Оплачивает через SmartShell
  │ 3. Закрывает окно оплаты
  │
  ▼
SMARTSHELL
  │
  │ 4. Обрабатывает платеж
  │ 5. Отправляет webhook на backend
  │
  ▼
BACKEND
  │
  │ 6. POST /api/payment/callback
  │ 7. Проверяет подпись
  │ 8. Добавляет деньги на баланс
  │ 9. io.to(`user:${userId}`).emit('balance:updated:${userId}')
  │
  ▼
FRONTEND (пользователь который оплатил)
  │
  │ 10. Получает 'balance:updated'
  │ 11. refreshProfile()
  │ 12. TopBar показывает +100€
  │ 13. Toast: "Баланс пополнен!"
  │
  ✅ ГОТОВО!
```

**Результат:** Деньги появляются мгновенно БЕЗ перезагрузки!

---

## 🔴 Сценарий 4: Интернет пропал

```
ПОЛЬЗОВАТЕЛЬ
  │
  │ Пропал интернет...
  │
  ▼
FRONTEND
  │
  │ 1. WebSocket disconnect
  │ 2. Индикатор становится красным 🔴
  │ 3. Tooltip: "Reconnecting..."
  │ 4. Автоматически пытается переподключиться
  │
  │ ... проходит 5 секунд ...
  │
  │ Интернет вернулся!
  │
  ▼
FRONTEND
  │
  │ 5. WebSocket reconnect
  │ 6. Индикатор становится зеленым 🟢
  │ 7. socket.emit('user:identify', { userId })
  │ 8. Подписывается на события снова
  │
  ✅ ВСЁ РАБОТАЕТ!
```

**Результат:** Автоматическое восстановление соединения!

---

## 🎯 Какие события когда отправлять?

### cases:updated - Всем клиентам

```typescript
io.emit('cases:updated');
```

**Когда:**
- ✅ Админ создал кейс
- ✅ Админ обновил кейс
- ✅ Админ удалил кейс
- ✅ Админ изменил цену
- ✅ Админ добавил/удалил предметы

**Кто получит:** ВСЕ пользователи на сайте

**Что произойдет:** Список кейсов обновится у всех

---

### balance:updated:userId - Конкретному пользователю

```typescript
io.to(`user:${userId}`).emit(`balance:updated:${userId}`, { 
  balance: 1234.56 
});
```

**Когда:**
- ✅ Пользователь открыл кейс (списание)
- ✅ Пользователь пополнил баланс
- ✅ Пользователь получил деньги за предмет
- ✅ Админ начислил/списал деньги

**Кто получит:** ТОЛЬКО этот пользователь

**Что произойдет:** TopBar обновит баланс

---

### inventory:updated:userId - Конкретному пользователю

```typescript
io.to(`user:${userId}`).emit(`inventory:updated:${userId}`);
```

**Когда:**
- ✅ Пользователь выиграл предмет
- ✅ Пользователь получил деньги за предмет
- ✅ Статус предмета изменился

**Кто получит:** ТОЛЬКО этот пользователь

**Что произойдет:** Инвентарь обновится

---

## 🟢 Индикатор подключения

### Зеленый (Connected)

```
┌──────────────────────┐
│  ⚙️   🟢   👤         │
│  Settings Wi-Fi User │
└──────────────────────┘

Tooltip:
┌────────────────────────┐
│ Real-time Connection   │
│ 🟢 Connected          │
│ Live updates enabled   │
└────────────────────────┘
```

**Что это значит:**
- ✅ WebSocket подключен
- ✅ События приходят в реальном времени
- ✅ Всё работает отлично!

---

### Красный (Disconnected)

```
┌──────────────────────┐
│  ⚙️   🔴   👤         │
│  Settings WiFi-Off   │
└──────────────────────┘
      ↑ пульсирует

Tooltip:
┌────────────────────────┐
│ Real-time Connection   │
│ 🔴 Disconnected       │
│ Reconnecting...        │
└────────────────────────┘
```

**Что это значит:**
- ⚠️ WebSocket отключен
- ⚠️ Автоматически пытается переподключиться
- ⚠️ События не приходят (но придут после переподключения)

---

## 📊 Мониторинг в реальном времени

### Backend Логи

```bash
docker-compose logs -f backend
```

**Что увидишь:**

```
✅ Server with WebSocket running on port 3000
🟢 Client connected: abc123xyz
👤 User identified: user_456 socket: abc123xyz
📦 WebSocket: cases:updated emitted
💰 WebSocket: balance updated for user user_456
🎒 WebSocket: inventory updated for user user_456
🔴 Client disconnected: abc123xyz reason: transport close
```

---

### Frontend Console

```javascript
// Открой DevTools → Console
```

**Что увидишь:**

```
🔌 Initializing WebSocket connection...
✅ WebSocket connected: abc123xyz
📦 Cases updated by admin, refreshing list...
💰 Balance updated: 1234.56
🎒 Inventory updated
```

---

### Health Check

```bash
curl http://91.107.120.48:3000/health
```

**Ответ:**

```json
{
  "status": "ok",
  "websocket": "active",
  "clients": 42,
  "timestamp": "2024-12-30T12:00:00.000Z"
}
```

**Что это значит:**
- `status: "ok"` - Сервер работает
- `websocket: "active"` - WebSocket активен
- `clients: 42` - 42 пользователя онлайн
- `timestamp` - Текущее время сервера

---

## 🎮 Преимущества для UX

### До WebSocket ❌

```
Пользователь                          Сервер
    │                                    │
    │ 1. Открывает главную               │
    │ ────────────────────────────────>  │
    │                                    │ Список кейсов
    │ <────────────────────────────────  │
    │                                    │
    │ ... работает на сайте ...          │
    │                                    │
    │                        Админ добавил кейс!
    │                                    │
    │ ... НЕ ВИДИТ новый кейс ...        │
    │                                    │
    │ 2. F5 (перезагрузка)               │
    │ ────────────────────────────────>  │
    │                                    │ Обновленный список
    │ <────────────────────────────────  │
    │                                    │
    │ 3. ТЕПЕРЬ видит!                   │
```

**Проблемы:**
- ❌ Нужно вручную обновлять страницу
- ❌ Не видишь изменения в реальном времени
- ❌ Неудобно!

---

### С WebSocket ✅

```
Пользователь                          Сервер
    │                                    │
    │ 1. Открывает главную               │
    │ ────────────────────────────────>  │
    │                                    │
    │ 2. WebSocket подключается          │
    │ <=================================  │
    │                                    │
    │ ... работает на сайте ...          │
    │                                    │
    │                        Админ добавил кейс!
    │                                    │
    │ 3. cases:updated                   │
    │ <==================================  │
    │                                    │
    │ 4. СРАЗУ видит новый кейс!         │
    │    БЕЗ перезагрузки!               │
```

**Преимущества:**
- ✅ Мгновенные обновления
- ✅ Не нужно ничего перезагружать
- ✅ Smooth UX как в нативных приложениях
- ✅ Игровой опыт как в CS:GO!

---

## 🚀 Итоги

### Что получаешь с WebSocket:

1. **Мгновенные обновления** - кейсы, баланс, инвентарь
2. **Нет перезагрузок** - smooth как масло
3. **Auto-reconnect** - сам переподключается
4. **Визуальный индикатор** - видишь статус подключения
5. **Desktop ready** - работает в .exe
6. **Browser ready** - работает в Chrome/Firefox/Safari
7. **Production ready** - готово к деплою

### Что НЕ меняется:

- ✅ Существующий API работает как раньше
- ✅ HTTP endpoints не меняются
- ✅ База данных та же
- ✅ Ничего не ломается

### Что добавляется:

- 🆕 WebSocket сервер (параллельно HTTP)
- 🆕 Real-time события
- 🆕 Индикатор подключения
- 🆕 Auto-reconnect механизм

---

**Всё просто! WebSocket = обычный HTTP + real-time magic! ✨**
